---
- name: Update all packages
  ansible.builtin.dnf:
    name: "*"
    state: latest
    update_cache: true

- name: Install prerequisite packages
  ansible.builtin.dnf:
    name:
      - python3
      - python3-pip
      - wget
      - curl
      - git
      - rsync
      - tar
      - unzip
      - openssl
      - podman
      - firewalld
      - vim
      - tmux
    state: present

- name: Install Ansible core (required for AAP installer)
  ansible.builtin.dnf:
    name:
      - ansible-core
    state: present

- name: Set SELinux to permissive (required for AAP installation)
  ansible.posix.selinux:
    policy: targeted
    state: permissive

- name: Persist SELinux permissive mode
  ansible.builtin.lineinfile:
    path: /etc/selinux/config
    regexp: '^SELINUX='
    line: 'SELINUX=permissive'
    state: present

- name: Ensure firewalld is enabled and running
  ansible.builtin.systemd:
    name: firewalld
    state: started
    enabled: true

- name: Configure firewall rules for AAP
  ansible.posix.firewalld:
    port: "{{ item }}"
    permanent: true
    immediate: true
    state: enabled
  loop:
    - "22/tcp"      # SSH
    - "80/tcp"      # HTTP (redirects to HTTPS)
    - "443/tcp"     # HTTPS - Controller Web UI & API
    - "5432/tcp"    # PostgreSQL (internal)
    - "8443/tcp"    # Automation Hub Web UI
    - "27199/tcp"   # Receptor mesh
  ignore_errors: true

- name: Configure system limits for AAP
  ansible.builtin.copy:
    dest: /etc/security/limits.d/99-aap.conf
    content: |
      # AAP system limits
      *    soft    nofile    65536
      *    hard    nofile    65536
      *    soft    nproc     4096
      *    hard    nproc     4096
    owner: root
    group: root
    mode: '0644'

- name: Configure kernel parameters for AAP
  ansible.posix.sysctl:
    name: "{{ item.key }}"
    value: "{{ item.value }}"
    sysctl_set: true
    state: present
    reload: true
  loop:
    - { key: "net.ipv4.ip_forward", value: "1" }
    - { key: "fs.inotify.max_user_watches", value: "524288" }
    - { key: "vm.max_map_count", value: "262144" }
