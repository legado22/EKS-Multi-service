# =============================================================================
# RHEL 9 Kickstart for AAP vSphere Template
# =============================================================================
# Automated OS installation for Packer vSphere builds.
# Creates a minimal RHEL 9 server with the AAP build user.
# =============================================================================

# System language and keyboard
lang en_US.UTF-8
keyboard us
timezone UTC --utc

# Network (DHCP - adjust if bank requires static IP during build)
network --bootproto=dhcp --onboot=yes --activate

# Installation source (from mounted ISO)
cdrom

# Partitioning - single root partition (AAP needs space for container images)
zerombr
clearpart --all --initlabel
autopart --type=lvm --fstype=xfs

# Boot loader
bootloader --location=mbr --append="crashkernel=auto"

# Root password (locked - use sudo via aapuser)
rootpw --lock

# Create the AAP build user with sudo access
user --name=aapuser --groups=wheel --plaintext --password=CHANGE_ME_IN_PKRVARS

# SELinux and firewall
selinux --enforcing
firewall --enabled --ssh --port=443:tcp --port=8443:tcp

# Disable initial setup wizard
firstboot --disable
eula --agreed

# Package selection
%packages --ignoremissing
@^minimal-environment
open-vm-tools
python3
sudo
tar
unzip
curl
%end

# Post-installation
%post --log=/root/ks-post.log
# Enable open-vm-tools for vCenter guest customization
systemctl enable vmtoolsd

# Allow wheel group passwordless sudo (for Packer/Ansible provisioning)
echo "%wheel ALL=(ALL) NOPASSWD: ALL" > /etc/sudoers.d/wheel-nopasswd
chmod 440 /etc/sudoers.d/wheel-nopasswd

# Enable SSH
systemctl enable sshd
%end

# Reboot after installation
reboot --eject
